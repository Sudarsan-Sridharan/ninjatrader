package com.bn.ninjatrader.simulation.order.type;

import com.bn.ninjatrader.model.entity.Price;
import com.bn.ninjatrader.model.entity.PriceBuilderFactory;
import com.bn.ninjatrader.model.util.DummyPriceBuilderFactory;
import com.bn.ninjatrader.simulation.data.BarData;
import com.bn.ninjatrader.simulation.util.DummyObjectMapperProvider;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.google.common.collect.Sets;
import org.junit.Before;
import org.junit.Test;

import java.io.IOException;

import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.when;

/**
 * @author bradwee2000@gmail.com
 */
public class MarketOpenTest {

  private final PriceBuilderFactory pbf = new DummyPriceBuilderFactory();
  private final Price price = pbf.builder().open(1.1).high(2).low(3).close(4).build();
  private final MarketOpen marketOpen = new MarketOpen();

  private BarData submittedBarData;
  private BarData currentBarData;

  @Before
  public void before() {
    submittedBarData = mock(BarData.class);
    currentBarData = mock(BarData.class);

    when(currentBarData.getPrice()).thenReturn(price);
  }

  @Test
  public void testIsFulfillable_shouldAlwaysReturnTrue() {
    assertThat(marketOpen.isFulfillable(submittedBarData, currentBarData)).isTrue();
  }

  @Test
  public void testGetFulfilledPrice_shouldReturnPriceAtOpen() {
    assertThat(marketOpen.getFulfilledPrice(submittedBarData, currentBarData)).isEqualTo(1.1);
  }

  @Test
  public void testGetVariables_shouldReturnEmptySet() {
    assertThat(marketOpen.getVariables()).isEmpty();
  }

  @Test
  public void testEquals_shouldBeEqualIfAllPropertiesAreEqual() {
    assertThat(marketOpen).isEqualTo(new MarketOpen())
        .isNotEqualTo(null)
        .isNotEqualTo("");
  }

  @Test
  public void testHashcode_shouldHaveEqualHashcodeIfAllPropertiesAreEqual() {
    assertThat(Sets.newHashSet(marketOpen, new MarketOpen()))
        .containsExactlyInAnyOrder(marketOpen);
  }

  @Test
  public void testSerializeDeserialize_shouldProduceEqualObject() throws IOException {
    final ObjectMapper om = DummyObjectMapperProvider.get();
    final String json = om.writeValueAsString(marketOpen);
    assertThat(om.readValue(json, OrderType.class)).isEqualTo(marketOpen);
  }
}
